<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Itinerario Mauritius</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 300px;
      overflow-y: auto;
      padding: 10px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      position: relative;
      z-index: 1000;
    }
    #map { flex: 1; }
    #summary {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 320px;
      max-height: 90vh;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1100;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .day { margin-bottom: 15px; }
    .day h3 {
      margin: 5px 0; padding: 5px; background: #eee; border-left: 3px solid #666;
      display: flex; justify-content: space-between; align-items: center;
    }
    .badge {
      background: #3498db; color: #fff; font-weight: bold; font-size: 12px;
      border-radius: 10px; padding: 2px 8px;
    }
    .stop {
      padding: 5px; margin-left: 10px; border-bottom: 1px dashed #ccc; cursor: grab;
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; background: #fff;
    }
    .stop:active { cursor: grabbing; }
    .stop.dragging { opacity: 0.6; }
    .drop-target { outline: 2px dashed #3498db; }
    .placeholder { height: 36px; margin-left: 10px; border: 2px dashed #3498db; background: #eaf4ff; }

    .btn-group { display: flex; gap: 5px; margin-left: 5px; }
    .remove-btn, .edit-btn, .save-btn, .cancel-btn {
      background: #e74c3c; border: none; color: white; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 0.9em;
    }
    .edit-btn { background: #3498db; }
    .save-btn { background: #2ecc71; }
    .cancel-btn { background: #95a5a6; }

    /* Collapsible add form */
    .collapsible-header {
      display: flex; align-items: center; justify-content: space-between;
      background: #eef3f7; border: 1px solid #cfd8dc; border-radius: 6px;
      padding: 8px 10px; margin-bottom: 8px; cursor: pointer; user-select: none;
      font-weight: bold;
    }
    .collapsible-header .caret { transition: transform .2s ease; }
    .collapsible.open .collapsible-header .caret { transform: rotate(180deg); }
    .collapsible-body[hidden] { display: none !important; }

    #add-stop-form {
      padding: 8px; border: 1px solid #ccc; background: #fff; margin-bottom: 10px; border-radius: 4px;
    }

    #images-bar {
      position: absolute; bottom: 0; left: 300px; right: 0; height: 150px; background: white; border-top: 1px solid #ccc;
      overflow-x: auto; white-space: nowrap; z-index: 1050; display: flex; align-items: center; padding: 5px;
      transition: transform .25s ease, height .25s ease;
    }
    #images-bar img {
      height: 140px; margin-right: 5px; border-radius: 4px; object-fit: cover;
    }
    #images-grip { display: none; }

    label { display: block; margin-top: 5px; }
    input { width: 100%; box-sizing: border-box; padding: 4px; margin-top: 2px; }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body { flex-direction: column; height: 100dvh; }
      #map { flex: none; height: 100dvh; }
      #sidebar {
        position: fixed;
        top: 0; left: 0; right: 0;
        height: 60vh;
        z-index: 1300;
        transform: translateY(-100%);
        transition: transform .25s ease;
        border-right: none; border-bottom: 1px solid #ccc;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      }
      #sidebar.open { transform: translateY(0); }
      #summary {
        position: fixed;
        left: 0; right: 0;
        bottom: 150px;
        top: auto;
        width: auto;
        max-height: 40vh;
        z-index: 1200;
      }
      #images-bar {
        position: fixed;
        left: 0; right: 0;
        bottom: 0;
        height: 150px;
        z-index: 1200;
      }
      #images-bar.collapsed {
        height: 36px;
        overflow: hidden;
      }
      #images-grip {
        display: block;
        position: absolute;
        top: 6px; left: 50%;
        transform: translateX(-50%);
        width: 36px; height: 4px;
        background: #bbb; border-radius: 3px;
        cursor: pointer;
      }
      .floating-toggle {
        position: fixed;
        top: 10px; left: 10px;
        z-index: 1400;
        background: #fff; border: 1px solid #ccc; border-radius: 6px;
        padding: 8px 12px; font-weight: bold; cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="add-stop-wrapper" class="collapsible">
      <div id="add-stop-header" class="collapsible-header" role="button" aria-expanded="false">
        <span>Aggiungi nuova tappa</span>
        <span class="caret">▾</span>
      </div>
      <form id="add-stop-form" class="collapsible-body" autocomplete="off" hidden>
        <label>Giorno (es: 29/09)</label>
        <input type="text" id="new-day" placeholder="gg/mm" required />
        <label>Nome tappa</label>
        <input type="text" id="new-name" placeholder="Nome luogo" required />
        <label>Orario</label>
        <input type="text" id="new-time" placeholder="es: 09:00" required />
        <label>Durata</label>
        <input type="text" id="new-duration" placeholder="es: 2h" required />
        <label>Località (indirizzo)</label>
        <input type="text" id="new-location" placeholder="Luogo completo" required />
        <button type="submit">Aggiungi tappa</button>
      </form>
    </div>
    <div id="itinerary-container"></div>
  </div>

  <div id="map"></div>
  <button id="toggleSidebar" class="floating-toggle" aria-label="Apri/chiudi menu">Menu</button>

  <div id="summary">Seleziona una tappa per i dettagli</div>
  <div id="images-bar">
    <div id="images-grip" aria-label="Riduci/espandi immagini" title="Riduci/espandi"> </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- API Places per Autocomplete -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTjbAwYVPqXwl5g2feXJhKyXRQZENMpO4&libraries=places&callback=enableAutocomplete" async defer></script>
  <script>
    // ---- Dati ----
    const itinerary = [
      { day: "21/09 - Arrivo", stops: [
        { name: "Riu Palace Mauritius", time: "15:00", duration: "tutto il pomeriggio", location: "Riu Palace Mauritius, Le Morne, Mauritius", lat: null, lng: null, description: "Hotel Riu Palace, bel resort a Le Morne." }
      ]},
      { day: "22/09 - Delfini & Île aux Bénitiers", stops: [
        { name: "Delfini", time: "06:30", duration: "4-5h", location: "Tamarin Bay, Mauritius" },
        { name: "Crystal Rock", time: "09:00", duration: "—", location: "Crystal Rock, Mauritius" },
        { name: "Île aux Bénitiers", time: "10:30", duration: "—", location: "Île aux Bénitiers, Mauritius" }
      ]},
      { day: "23/09 - Chamarel", stops: [
        { name: "Cascata Chamarel", time: "09:00", duration: "—", location: "Chamarel Waterfall, Mauritius" },
        { name: "Terre Colorate", time: "10:00", duration: "—", location: "Chamarel Seven Colored Earth Geopark, Mauritius" },
        { name: "Rhumerie de Chamarel", time: "11:00", duration: "—", location: "Rhumerie de Chamarel, Mauritius" }
      ]},
      { day: "24/09 - Blue Bay", stops: [
        { name: "Blue Bay Marine Park", time: "08:30", duration: "3-4h", location: "Blue Bay Marine Park, Mauritius" }
      ]},
      { day: "25/09 - Black River & Ganga Talao", stops: [
        { name: "Black River Gorges", time: "08:00", duration: "5-6h", location: "Black River Gorges National Park, Mauritius" },
        { name: "Ganga Talao", time: "11:00", duration: "—", location: "Ganga Talao, Mauritius" }
      ]},
      { day: "26/09 - Isole del Nord", stops: [
        { name: "Îlot Gabriel", time: "07:00", duration: "6-7h", location: "Îlot Gabriel, Mauritius" },
        { name: "Coin de Mire", time: "09:00", duration: "—", location: "Coin de Mire, Mauritius" },
        { name: "Île Plate", time: "11:00", duration: "—", location: "Île Plate, Mauritius" }
      ]},
      { day: "27/09 - Port Louis", stops: [
        { name: "Port Louis", time: "09:00", duration: "3-4h", location: "Port Louis, Mauritius" },
        { name: "Caudan Waterfront", time: "11:00", duration: "—", location: "Caudan Waterfront, Mauritius" }
      ]},
      { day: "28/09 - Relax & Partenza", stops: [
        { name: "Relax hotel", time: "08:00", duration: "fino al transfer aeroporto", location: "Flic en Flac, Mauritius" }
      ]}
    ];

    // ---- Map ----
    const map = L.map('map').setView([-20.2, 57.5], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    // ---- DOM ----
    const sidebar = document.getElementById("sidebar");
    const itineraryContainer = document.getElementById("itinerary-container");
    const summary = document.getElementById("summary");
    const imagesBar = document.getElementById("images-bar");
    const imagesGrip = document.getElementById("images-grip");
    const addWrapper = document.getElementById("add-stop-wrapper");
    const addHeader = document.getElementById("add-stop-header");
    const addFormEl = document.getElementById("add-stop-form");
    const toggleBtn = document.getElementById("toggleSidebar");

    // ---- State ----
    const apiKey = "AIzaSyDTjbAwYVPqXwl5g2feXJhKyXRQZENMpO4";
    let markers = [];
    let dragData = null;
    let touchDrag = { active: false, el: null, placeholder: null, fromDay: null, fromIndex: null };

    // ---- Collapsible Add Form (default chiuso, persistito) ----
    const savedAddState = sessionStorage.getItem("addFormOpen");
    let addOpen = savedAddState ? savedAddState === "1" : false;
    applyAddFormState(addOpen);
    addHeader.addEventListener("click", () => {
      addOpen = !addOpen;
      applyAddFormState(addOpen);
      sessionStorage.setItem("addFormOpen", addOpen ? "1" : "0");
    });
    function applyAddFormState(open) {
      if (open) {
        addWrapper.classList.add("open");
        addFormEl.hidden = false;
        addHeader.setAttribute("aria-expanded", "true");
      } else {
        addWrapper.classList.remove("open");
        addFormEl.hidden = true;
        addHeader.setAttribute("aria-expanded", "false");
      }
    }

    // ---- Sidebar toggle mobile ----
    toggleBtn?.addEventListener("click", () => {
      sidebar.classList.toggle("open");
    });

    // ---- Images bar toggle + persistence ----
    const savedCollapsed = sessionStorage.getItem("imagesCollapsed");
    if (savedCollapsed === "1") imagesBar.classList.add("collapsed");
    imagesGrip?.addEventListener("click", () => {
      imagesBar.classList.toggle("collapsed");
      sessionStorage.setItem("imagesCollapsed", imagesBar.classList.contains("collapsed") ? "1" : "0");
    });
    if (window.matchMedia("(max-width: 768px)").matches) {
      map.on('click', () => imagesBar.classList.add("collapsed"));
      map.scrollWheelZoom.disable();
    }

    // ---- Google Places Autocomplete ----
    function enableAutocomplete() {
      const addInput = document.getElementById("new-location");
      if (addInput && window.google?.maps?.places) {
        const acAdd = new google.maps.places.Autocomplete(addInput, { types: ["geocode"] });
        acAdd.setFields(["formatted_address"]);
        acAdd.addListener("place_changed", () => {
          const place = acAdd.getPlace();
          if (place?.formatted_address) addInput.value = place.formatted_address;
        });
      }
    }

    // ---- Utils ----
    function haversine(a, b) {
      const R = 6371000;
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const la1 = toRad(a.lat);
      const la2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(la1) * Math.cos(la2) * Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    async function getCoords(place) {
      const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(place)}&key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.results && data.results[0]) return data.results[0].geometry.location;
      return null;
    }

    async function reverseGeocode(latlng) {
      const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latlng.lat},${latlng.lng}&key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.results && data.results[0]) return data.results[0].formatted_address;
      return null;
    }

    async function normalizeHotelPosition(stop) {
      if (!stop) return;
      const query = "Riu Palace Mauritius, Le Morne, Mauritius";
      const coords = await getCoords(query);
      if (!coords) return;
      const fromGoogle = { lat: coords.lat, lng: coords.lng };
      const current = { lat: stop.lat ?? fromGoogle.lat, lng: stop.lng ?? fromGoogle.lng };
      if (!stop.lat || !stop.lng || haversine(current, fromGoogle) > 30) {
        stop.lat = fromGoogle.lat;
        stop.lng = fromGoogle.lng;
        stop.location = query;
      }
    }

    async function loadImages(query) {
      imagesBar.innerHTML = "<div id='images-grip' aria-label='Riduci/espandi immagini' title='Riduci/espandi'> </div>";
      try {
        const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=10&client_id=oscq1UoIBx0SNx21vw5uLFcziiArSsEFHWWscypGYsg`);
        const data = await response.json();
        if (!data.results || data.results.length === 0) {
          imagesBar.innerHTML = "<div id='images-grip'></div><p style='padding:10px;color:#666;'>Nessuna immagine trovata</p>";
          attachGrip(); return;
        }
        imagesBar.innerHTML = "<div id='images-grip' aria-label='Riduci/espandi immagini' title='Riduci/espandi'> </div>";
        data.results.forEach(img => {
          const el = document.createElement("img");
          el.loading = "lazy";
          el.decoding = "async";
          el.src = img.urls.small;
          el.alt = img.alt_description || "Foto";
          imagesBar.appendChild(el);
        });
        attachGrip();
      } catch (err) {
        console.error("Errore Unsplash:", err);
        imagesBar.innerHTML = "<div id='images-grip'></div><p style='padding:10px;color:red;'>Errore caricamento immagini</p>";
        attachGrip();
      }
    }

    function attachGrip() {
      const grip = document.getElementById("images-grip");
      grip?.addEventListener("click", () => {
        imagesBar.classList.toggle("collapsed");
        sessionStorage.setItem("imagesCollapsed", imagesBar.classList.contains("collapsed") ? "1" : "0");
      }, { once: false });
    }

    function focusAndShow(day, stop, d, s) {
      if (stop.lat != null && stop.lng != null) map.setView([stop.lat, stop.lng], 14);
      showSummary(day, stop, d, s);
      loadImages(stop.name + " Mauritius");
      sidebar.classList.remove("open");
    }

    // ---- Drag & Drop ----
    function makeDraggableStop(stopDiv, dayIndex, stopIndex) {
      stopDiv.setAttribute("draggable", "true");
      stopDiv.addEventListener("dragstart", (e) => {
        dragData = { fromDay: dayIndex, fromIndex: stopIndex };
        stopDiv.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        try { e.dataTransfer.setData("text/plain", JSON.stringify(dragData)); } catch(_) {}
      });
      stopDiv.addEventListener("dragend", () => {
        stopDiv.classList.remove("dragging");
        dragData = null;
        document.querySelectorAll(".drop-target").forEach(el => el.classList.remove("drop-target"));
        removePlaceholder();
      });

      stopDiv.addEventListener("touchstart", () => {
        touchDrag.active = true;
        touchDrag.el = stopDiv;
        touchDrag.fromDay = dayIndex;
        touchDrag.fromIndex = stopIndex;
        stopDiv.classList.add("dragging");
        createPlaceholder(stopDiv);
      }, { passive: true });

      stopDiv.addEventListener("touchmove", (e) => {
        if (!touchDrag.active) return;
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        highlightDropTargets(target);
      }, { passive: true });

      stopDiv.addEventListener("touchend", async (e) => {
        if (!touchDrag.active) return;
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const dropInfo = resolveDropTarget(target);
        const { fromDay, fromIndex } = touchDrag;
        touchDrag.active = false;
        stopDiv.classList.remove("dragging");
        document.querySelectorAll(".drop-target").forEach(el => el.classList.remove("drop-target"));
        removePlaceholder();
        if (dropInfo && fromDay != null && fromIndex != null) {
          moveStop(fromDay, fromIndex, dropInfo.dayIndex, dropInfo.insertIndex);
          await renderSidebar();
          await renderMarkers();
        }
        touchDrag = { active: false, el: null, placeholder: null, fromDay: null, fromIndex: null };
      });
    }

    function createPlaceholder(refEl) {
      removePlaceholder();
      const ph = document.createElement("div");
      ph.className = "placeholder";
      refEl.parentNode.insertBefore(ph, refEl.nextSibling);
      touchDrag.placeholder = ph;
    }
    function removePlaceholder() {
      if (touchDrag.placeholder && touchDrag.placeholder.parentNode) {
        touchDrag.placeholder.parentNode.removeChild(touchDrag.placeholder);
      }
      touchDrag.placeholder = null;
    }
    function highlightDropTargets(target) {
      document.querySelectorAll(".drop-target").forEach(el => el.classList.remove("drop-target"));
      const dayBlock = target?.closest?.(".day");
      if (dayBlock) dayBlock.classList.add("drop-target");
    }
    function resolveDropTarget(target) {
      const dayBlock = target?.closest?.(".day");
      if (!dayBlock) return null;
      const dayIndex = [...itineraryContainer.children].indexOf(dayBlock);
      const stopEl = target?.closest?.(".stop");
      let insertIndex = itinerary[dayIndex].stops.length;
      if (stopEl && stopEl.dataset?.stopIndex != null) insertIndex = Number(stopEl.dataset.stopIndex);
      return { dayIndex, insertIndex };
    }
    function makeDroppableDay(dayContainer, dayIndex) {
      dayContainer.addEventListener("dragover", (e) => {
        if (!dragData) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        dayContainer.classList.add("drop-target");
      });
      dayContainer.addEventListener("dragleave", () => {
        dayContainer.classList.remove("drop-target");
      });
      dayContainer.addEventListener("drop", async (e) => {
        e.preventDefault();
        dayContainer.classList.remove("drop-target");
        if (!dragData) return;
        const { fromDay, fromIndex } = dragData;
        let insertIndex = itinerary[dayIndex].stops.length;
        const afterElement = getDropPositionElement(dayContainer, e.clientY);
        if (afterElement && afterElement.dataset?.stopIndex) insertIndex = Number(afterElement.dataset.stopIndex);
        moveStop(fromDay, fromIndex, dayIndex, insertIndex);
        await renderSidebar();
        await renderMarkers();
      });
    }
    function getDropPositionElement(dayContainer, mouseY) {
      const stopEls = [...dayContainer.querySelectorAll(".stop[data-stop-index]")];
      let closest = null;
      let closestOffset = Number.NEGATIVE_INFINITY;
      for (const el of stopEls) {
        const box = el.getBoundingClientRect();
        const offset = mouseY - (box.top + box.height / 2);
        if (offset < 0 && offset > closestOffset) { closestOffset = offset; closest = el; }
      }
      return closest;
    }
    function moveStop(fromDay, fromIndex, toDay, toIndex) {
      if (fromDay === toDay && fromIndex === toIndex) return;
      const [moved] = itinerary[fromDay].stops.splice(fromIndex, 1);
      const targetLen = itinerary[toDay].stops.length;
      const idx = Math.max(0, Math.min(toIndex, targetLen));
      itinerary[toDay].stops.splice(idx, 0, moved);
    }

    // ---- Sidebar render ----
    async function renderSidebar() {
      itineraryContainer.innerHTML = "";
      for(let d = 0; d < itinerary.length; d++) {
        const day = itinerary[d];
        const dayDiv = document.createElement("div");
        dayDiv.className = "day";
        dayDiv.innerHTML = `<h3>${day.day}<span class="badge" title="Numero tappe">${day.stops.length}</span></h3>`;
        itineraryContainer.appendChild(dayDiv);
        makeDroppableDay(dayDiv, d);

        for(let s = 0; s < day.stops.length; s++) {
          const stop = day.stops[s];
          const stopDiv = document.createElement("div");
          stopDiv.className = "stop";
          stopDiv.dataset.editing = "false";
          stopDiv.dataset.stopIndex = s;
          stopDiv.innerHTML = `<span class="stop-text">${d+1}.${s+1} - ${stop.name} (${stop.time})</span>`;

          makeDraggableStop(stopDiv, d, s);

          const btnGroup = document.createElement("div");
          btnGroup.className = "btn-group";

          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.textContent = "Modifica";

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "×";

          btnGroup.appendChild(editBtn);
          btnGroup.appendChild(removeBtn);
          stopDiv.appendChild(btnGroup);

          dayDiv.appendChild(stopDiv);

          stopDiv.querySelector(".stop-text").addEventListener("click", () => {
            if (stopDiv.dataset.editing === "false") {
              if(markers[d] && markers[d][s]) {
                const marker = markers[d][s];
                map.setView(marker.getLatLng(), 13);
                marker.openPopup();
                focusAndShow(day, stop, d, s);
              }
            }
          });

          removeBtn.onclick = () => removeStop(d, s);
          editBtn.onclick = () => {
            if(stopDiv.dataset.editing === "false") enterEditMode(stopDiv, stop, d, s);
          };
        }
      }
    }

    // ---- Editing ----
    function enterEditMode(stopDiv, stop, dayIndex, stopIndex) {
      stopDiv.dataset.editing = "true";
      stopDiv.innerHTML = "";
      stopDiv.style.flexWrap = "wrap";

      stopDiv.innerHTML = `
        <input type="text" class="edit-name" value="${stop.name}" placeholder="Nome" />
        <input type="text" class="edit-time" value="${stop.time}" placeholder="Orario" />
        <input type="text" class="edit-duration" value="${stop.duration}" placeholder="Durata" />
        <input type="text" class="edit-location" value="${stop.location}" placeholder="Località" autocomplete="off" />
      `;

      const editLoc = stopDiv.querySelector(".edit-location");
      if (window.google?.maps?.places) {
        const acEdit = new google.maps.places.Autocomplete(editLoc, { types: ["geocode"] });
        acEdit.setFields(["formatted_address"]);
        acEdit.addListener("place_changed", () => {
          const place = acEdit.getPlace();
          if (place?.formatted_address) editLoc.value = place.formatted_address;
        });
      }

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group";

      const saveBtn = document.createElement("button");
      saveBtn.className = "save-btn";
      saveBtn.textContent = "Salva";

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "cancel-btn";
      cancelBtn.textContent = "Annulla";

      btnGroup.appendChild(saveBtn);
      btnGroup.appendChild(cancelBtn);
      stopDiv.appendChild(btnGroup);

      saveBtn.onclick = async () => {
        const newName = stopDiv.querySelector(".edit-name").value.trim();
        const newTime = stopDiv.querySelector(".edit-time").value.trim();
        const newDuration = stopDiv.querySelector(".edit-duration").value.trim();
        const newLocation = stopDiv.querySelector(".edit-location").value.trim();

        if(!newName || !newTime || !newDuration || !newLocation) {
          alert("Compila tutti i campi per modificare la tappa.");
          return;
        }

        const coords = await getCoords(newLocation);
        if(!coords) { alert("Località non valida."); return; }

        stop.name = newName;
        stop.time = newTime;
        stop.duration = newDuration;
        stop.location = newLocation;
        stop.lat = coords.lat;
        stop.lng = coords.lng;

        if (/riu palace/i.test(newName) || /riu palace/i.test(newLocation)) {
          await normalizeHotelPosition(stop);
        }

        await renderSidebar();
        await renderMarkers();
        summary.innerHTML = "Seleziona una tappa per i dettagli";
        imagesBar.innerHTML = "<div id='images-grip' aria-label='Riduci/espandi immagini' title='Riduci/espandi'> </div>";
        attachGrip();
      };

      cancelBtn.onclick = () => {
        stopDiv.dataset.editing = "false";
        renderSidebar();
      };
    }

    function removeStop(dayIndex, stopIndex) {
      itinerary[dayIndex].stops.splice(stopIndex, 1);
      if(markers[dayIndex] && markers[dayIndex][stopIndex]){
        map.removeLayer(markers[dayIndex][stopIndex]);
        markers[dayIndex].splice(stopIndex, 1);
      }
      renderSidebar();
      renderMarkers();
      summary.innerHTML = "Seleziona una tappa per i dettagli";
      imagesBar.innerHTML = "<div id='images-grip' aria-label='Riduci/espandi immagini' title='Riduci/espandi'> </div>";
      attachGrip();
    }

    // ---- Add stop ----
    addFormEl.onsubmit = async(e) => {
      e.preventDefault();
      const newDay = document.getElementById("new-day").value.trim();
      const newName = document.getElementById("new-name").value.trim();
      const newTime = document.getElementById("new-time").value.trim();
      const newDuration = document.getElementById("new-duration").value.trim();
      const newLocation = document.getElementById("new-location").value.trim();
      if(!newDay || !newName || !newTime || !newDuration || !newLocation) return alert("Compila tutti i campi.");

      let coords = await getCoords(newLocation);
      if(!coords) return alert("Località non trovata.");

      let dayIndex = itinerary.findIndex(d => d.day.startsWith(newDay));
      if(dayIndex === -1) {
        itinerary.push({ day: `${newDay} - Giorno aggiunto`, stops: [] });
        dayIndex = itinerary.length - 1;
      }

      const newStop = { name: newName, time: newTime, duration: newDuration, location: newLocation, lat: coords.lat, lng: coords.lng };
      if (/riu palace/i.test(newName) || /riu palace/i.test(newLocation)) {
        await normalizeHotelPosition(newStop);
      }

      itinerary[dayIndex].stops.push(newStop);

      renderSidebar();
      renderMarkers();
      addFormEl.reset();
    };

    // ---- Markers ----
    async function renderMarkers() {
      markers.flat().forEach(m => { if(m) map.removeLayer(m); });
      markers = [];

      for(let d = 0; d < itinerary.length; d++) {
        markers[d] = [];
        const day = itinerary[d];
        for(let s = 0; s < day.stops.length; s++) {
          let stop = day.stops[s];

          if (/riu palace/i.test(stop.name) || /riu palace/i.test(stop.location)) {
            await normalizeHotelPosition(stop);
          }

          let lat, lng;
          if(stop.lat != null && stop.lng != null) {
            lat = stop.lat; lng = stop.lng;
          } else {
            const coords = await getCoords(stop.location);
            if(coords) { lat = coords.lat; lng = coords.lng; stop.lat = lat; stop.lng = lng; }
            else continue;
          }

          const marker = L.marker([lat, lng], { draggable: true, riseOnHover: true, keyboard: true })
            .addTo(map)
            .bindPopup(`<b>${stop.name}</b><br>${stop.time}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.location)}" target="_blank">Apri in Google Maps</a>`);

          marker.on('click', () => focusAndShow(day, stop, d, s));

          marker.on('dragend', async function(e) {
            const latlng = e.target.getLatLng();
            const newAddress = await reverseGeocode(latlng);
            if(newAddress) {
              stop.location = newAddress;
              stop.lat = latlng.lat;
              stop.lng = latlng.lng;
              stop.name = newAddress.split(",")[0];

              if (/riu palace/i.test(stop.name) || /riu palace/i.test(stop.location)) {
                await normalizeHotelPosition(stop);
                marker.setLatLng([stop.lat, stop.lng]);
              }

              marker.setPopupContent(`<b>${stop.name}</b><br>${stop.time}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.location)}" target="_blank">Apri in Google Maps</a>`);
              await renderSidebar();
              focusAndShow(day, stop, d, s);
            }
          });

          markers[d][s] = marker;
        }
      }
    }

    // ---- Summary ----
    function showSummary(day, stop, dayIndex, stopIndex) {
      let html = `<h2>${stop.name}</h2>
        <p><b>Orario:</b> ${stop.time}</p>
        <p><b>Durata:</b> ${stop.duration}</p>
        <p><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(stop.location)}" target="_blank">Apri su Google Maps</a></p>
        <hr>
        <h3>Programma ${day.day}</h3>`;
      day.stops.forEach((s,i) => { html += `<p>${i+1}. ${s.name} - ${s.time} (${s.duration})</p>`; });

      html += `<hr><button id="book-btn">Prenota escursione</button>`;
      summary.innerHTML = html;
      document.getElementById("book-btn").onclick = () => {
        alert(`Prenotazione per l'escursione: ${stop.name}\nContattare l'agenzia per confermare.`);
      };
    }

    // ---- Init ----
    (async function init() {
      const hotel = itinerary[0]?.stops?.find(s => /riu palace/i.test(s.name) || /riu palace/i.test(s.location));
      await normalizeHotelPosition(hotel);

      await renderSidebar();
      await renderMarkers();

      attachGrip();
    })();
  </script>
</body>
</html>
